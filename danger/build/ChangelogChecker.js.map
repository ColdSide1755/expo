{"version":3,"file":"ChangelogChecker.js","sourceRoot":"","sources":["../src/ChangelogChecker.ts"],"names":[],"mappings":"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","sourcesContent":["// Provides dev-time typing structure for  `danger` - doesn't affect runtime.\nimport { DangerDSLType } from 'danger/distribution/dsl/DangerDSL';\nimport * as fs from 'fs';\nimport { groupBy } from 'lodash';\nimport * as path from 'path';\n\nimport { GithubWrapper } from './GithubWrapper';\nimport { getExpoRepositoryRootDir } from './Utils';\n\ndeclare var danger: DangerDSLType;\ndeclare function message(message: string): void;\ndeclare function warn(message: string): void;\ndeclare function fail(message: string): void;\n\nconst DEFAULT_CHANGELOG_ENTRY_KEY = 'default';\n\nenum ChangelogEntryType {\n  BUG_FIXES = '🐛 Bug fixes',\n  NEW_FEATURES = '🎉 New features',\n  BREAKING_CHANGES = '🛠 Breaking changes',\n}\n\nconst DEFAULT_ENTRY_TYPE = ChangelogEntryType.BUG_FIXES;\n\ntype ChangelogEntry = {\n  type: ChangelogEntryType;\n  message: string;\n};\n\ntype ChangelogEntries = {\n  [DEFAULT_CHANGELOG_ENTRY_KEY]: ChangelogEntry;\n  [key: string]: ChangelogEntry;\n};\n\n// Setup\nconst pr = danger.github.pr;\nconst modifiedFiles = danger.git.modified_files;\nconst github = new GithubWrapper(danger.github.api, pr.base.user.login, pr.base.repo.name);\n\n/**\n * @param packageName for example: `expo-image-picker` or `unimodules-constatns-interface`\n * @returns relatice path to package. For example: `packages/expo-image-picker/CHANGELOG.md`\n */\nfunction getPackageChangelogPath(packageName: string): string {\n  return path.join('packages', packageName, 'CHANGELOG.md');\n}\n\nfunction getTags(\n  entry: string\n): { packageName: string | typeof DEFAULT_CHANGELOG_ENTRY_KEY; type: ChangelogEntryType } | null {\n  const result = {\n    type: DEFAULT_ENTRY_TYPE,\n    packageName: DEFAULT_CHANGELOG_ENTRY_KEY,\n  };\n\n  const tags = entry.match(/\\[[^\\]]*\\]/g);\n  if (!tags) {\n    return result;\n  }\n  if (tags.length > 2) {\n    return null;\n  }\n\n  for (const tag of tags) {\n    switch (true) {\n      case /\\[[\\s-_]*(bug)?[\\s-_]*fix[\\s-_]*\\]/i.test(tag):\n        result.type = ChangelogEntryType.BUG_FIXES;\n        break;\n      case /\\[[\\s-_]*(new)?[\\s-_]*feature(s)?[\\s-_]*\\]/i.test(tag):\n        result.type = ChangelogEntryType.NEW_FEATURES;\n        break;\n      case /\\[[\\s-_]*breaking[\\s-_]*(change)?[\\s-_]*\\]/i.test(tag):\n        result.type = ChangelogEntryType.BREAKING_CHANGES;\n        break;\n      default:\n        result['packageName'] = tag.replace(/\\[|\\]/g, '').trim();\n    }\n  }\n\n  return result;\n}\n\n/**\n * Get suggested changelog entries from PR.\n *\n * If PR doesn't contais `# Changelog` section then this method returns:\n * {\n *   [DEFAULT_CHANGELOG_ENTRY_KEY]: <title of this pr without tags>\n * }\n * Otherwise it tries to parse PR's body.\n */\nfunction getChangelogSuggestionFromPR(): ChangelogEntries {\n  const changelogEntries = {\n    [DEFAULT_CHANGELOG_ENTRY_KEY]: {\n      type: DEFAULT_ENTRY_TYPE,\n      message: pr.title.replace(/\\[.*\\]/, '').trim(),\n    },\n  };\n\n  const changelogTag = pr.body.match(/#\\schangelog(([^#]*?)\\s?)*/i)?.[0]?.replace(/^-/, '');\n  if (changelogTag) {\n    changelogTag\n      .split('\\n')\n      .slice(1)\n      .map(line => line.trim())\n      .filter(line => line.length > 0)\n      .forEach(line => {\n        const tags = getTags(line);\n        console.log({ tags });\n        if (!tags) {\n          warn(`Cound't parse tags from PR's body. Line: ${line}.`);\n          return;\n        }\n\n        if (tags.packageName) {\n          changelogEntries[tags.packageName] = {\n            type: tags.type,\n            message: line.replace(/\\[.*\\]/, '').trim(),\n          };\n        }\n      });\n  }\n\n  return changelogEntries;\n}\n\n/**\n * Check if the changelog was modified.\n * If `CHANGELOG.md` doesn't exist in provided package, it retunrs false.\n */\nfunction wasChangelogModified(packageName: string, modifiedFiles: string[]): boolean {\n  const changelogPath = getPackageChangelogPath(packageName);\n\n  return (\n    modifiedFiles.includes(changelogPath) ||\n    !fs.existsSync(path.join(getExpoRepositoryRootDir(), changelogPath))\n  );\n}\n\n/**\n * Add additional information, like PRs author and PRs link, to the entry.\n */\nfunction addPRInfoToChangelogEntry(entry: string): string {\n  // We need to escape link in that way to display them in their raw form.\n  return `\\\\- ${entry} (\\\\[#<span/>${pr.number}](https:<span/>//github.com/expo/expo/pull/<span/>${pr.number}) by \\\\[@<span/>${pr.user.login}](https:<span/>//github.com/${pr.user.login}))`;\n}\n\nfunction getPackagesWithoutChangelogEntry(modifiedPackages: { [Key: string]: string[] }): string[] {\n  return Object.keys(modifiedPackages).filter(\n    packageName => !wasChangelogModified(packageName, modifiedPackages[packageName])\n  );\n}\n\nfunction getSuggestedChangelogEntries(\n  packagesWithoutChangelogEntry: string[]\n): ({ packageName: string } & ChangelogEntry)[] {\n  const {\n    DEFAULT_CHANGELOG_ENTRY_KEY: defaultEntry,\n    ...suggestedEntries\n  } = getChangelogSuggestionFromPR();\n\n  return packagesWithoutChangelogEntry.map(packageName => {\n    const message = addPRInfoToChangelogEntry(\n      suggestedEntries[packageName]?.message ?? defaultEntry.message\n    );\n    const type = suggestedEntries[packageName]?.type ?? defaultEntry.type;\n    return {\n      packageName,\n      message,\n      type,\n    };\n  });\n}\n\n// @ts-ignore\nasync function createOrUpdateRP(missingEntries: { packageName: string; entry: string }[]) {\n  const dangerHeadRef = `@danger/add-missing-changelog-to-${pr.number}`;\n  const dangerBaseRef = pr.head.ref;\n  const dangerMessage = `Add missing changelog to #${pr.number}`;\n  const dangerTags = `[danger][bot]`;\n\n  const prs = await github.getOpenPR({\n    fromBranch: dangerHeadRef,\n    toBranch: dangerBaseRef,\n  });\n\n  console.log(prs);\n  if (prs.length > 1) {\n    warn(\"Couldn't find a correct pull request. Too many open ones.\");\n    return;\n  }\n\n  if (prs.length === 1) {\n    // const dangerPR = prs[0];\n    // todo: check if this pr is up to date\n\n    return;\n  }\n\n  const fileMap = {\n    'test.md': `# Simple md`,\n  };\n\n  await github.createOrUpdateBranchFromFileMap(fileMap, {\n    baseBranchName: dangerBaseRef,\n    branchName: dangerHeadRef,\n    message: `${dangerTags} ${dangerMessage}`,\n  });\n\n  await github.openPR({\n    fromBranch: dangerHeadRef,\n    toBranch: dangerBaseRef,\n    title: `${dangerTags} ${dangerMessage}`,\n    body: dangerMessage,\n  });\n}\n\nfunction generateReport(missingEntries: Array<ChangelogEntry & { packageName: string }>) {\n  const message = missingEntries\n    .map(\n      missingEntry => `\n- <code>${danger.github.utils.fileLinks(\n        [getPackageChangelogPath(missingEntry.packageName)],\n        false\n      )}</code>\n\nSuggested entry:\n> _${missingEntry.message}_`\n    )\n    .join('');\n\n  fail(`\n📋 **Missing Changelog**\n------\n### 🛠 Add missing entires to:\n${message}`);\n}\n\nexport async function changelogCheck(): Promise<boolean> {\n  const modifiedPackages = groupBy(\n    modifiedFiles.filter(file => file.startsWith('packages')),\n    file => file.split(path.sep)[1]\n  );\n\n  const packagesWithoutChangelogEntry = getPackagesWithoutChangelogEntry(modifiedPackages);\n  console.log(packagesWithoutChangelogEntry);\n  if (packagesWithoutChangelogEntry.length === 0) {\n    message(`✅ **Changelog**`);\n    return true;\n  }\n\n  const suggestedEntries = getSuggestedChangelogEntries(packagesWithoutChangelogEntry);\n  generateReport(suggestedEntries);\n  console.log(suggestedEntries);\n\n  return true;\n}\n"]}